# deploy 填坑指南


## The web application

+ language: java 1.8
+ package: maven
+ web framework： sparkjava
+ server: jetty
+ version control: git
+ IDE: intelliJ 

## Tools I used

### Heroku

I choosed heroku for its documents are not very overwhelming. What I did to my web app:

+ add port assignment fundtion into Main class 

```java
static int getHerokuAssignedPort() {
        ProcessBuilder processBuilder = new ProcessBuilder();
        if (processBuilder.environment().get("PORT") != null) {
            return Integer.parseInt(processBuilder.environment().get("PORT"));
        }
        return 4567; //return default port if heroku-port isn't set (i.e. on localhost)
    }
```

+ pom.xml add maven dependency

```xml
<plugin>
    <groupId>com.heroku.sdk</groupId>
    <artifactId>heroku-maven-plugin</artifactId>
    <version>0.4.4</version>
    <configuration>
        <jdkVersion>1.8</jdkVersion>
        <!-- Use your own application name -->
        <appName>testjuji</appName>
        <processTypes>
            <!-- Tell Heroku how to launch your application -->
            <!-- You might have to remove the ./ in front   -->
            <web>java -jar ./target/todoapp1-1.0-jar-with-dependencies.jar</web>
        </processTypes>
    </configuration>
</plugin>
```

+ And add repository in my heroku account. The build and deploy result is:

![](./img/heroku.png)

It seems work but the linked generated by heroku is not work. Since juji use aws as deploy platform, so I switch to aws


## AWS

### Key words:
+ cloud model: (IaaS, PaaS, SaaS)
  ![](https://pic1.zhimg.com/v2-6f4d6a0e5b23c08376a5ed4684a40a78_b.png)
+ Reliability：Available zone, region zone. (至少要考虑到 AZ 级别)
+ Storage(备份)：S3 (simple storage service)
+ Security：
	+ IAM(identity access management)
	+ SG(security group) + ACL (access control list)
	+ Policy
	+ Users(access key & secret key)
+ dev, test(staging), product 环境：VPC(Virtual Private Cloud), seperate those environments by divided machines into several subnets. Also need IAM.
+ Scaling:
	+ EC2 auto scaling + ELB (elastic load balancer)
	+ Storage: S3
	+ Database: dynamodb(NoSQL), RDS (Relational).
	+ SQS(message queue): RabbitMQ, Kafka 
	+ Cache
+ Monitoring: CPU/IO/Network/memory
+ logging: 各种分布式log集中管理工具。
+ Deploy:
	+ CodeDeploy
	+ ElasticBeanstalk
	+ Opswork
	+ Cloud formation




### 1. [AWS CodeDeploy from github](http://docs.aws.amazon.com/codedeploy/latest/userguide/tutorials-github.html)


目前不打算用这种方案，因为中间的大部分环节其实并没有很清楚，步骤太多容易出错。

### 2. [Elastic Beanstalk](http://docs.aws.amazon.com/elasticbeanstalk/latest/dg/GettingStarted.html)


References:

[maven package](http://www.infoq.com/cn/news/2011/06/xxb-maven-9-package)

[locally deploy with jetty runner](https://devcenter.heroku.com/articles/deploy-a-java-web-application-that-launches-with-jetty-runner)

4月16日今天做的工作：

看了一下maven打包和部署的整个过程，看了ElasticBeanstalk的 java se platform 配置文档。主要文件是三个，pom, Procfile, Buildfile. 

另外ElasticBeanstalk采用了Nginx作为reverse proxy，会把request从port 80 forward to port 5000. 所以我把application 的启动端口改成了5000但是依然没有什么效果。

还做了一件事情就是在maven里面添加了jetty server 和 deploy plugin的一些dependency，refactor了之前的java project做成了一个webapp 的project 结构，index改成了 index.jsp, locally是可以打出一个.war，并且运行在jetty-runner.jar之上，同样的事情直接在instance上面可以deploy但是不能从公网访问，所以应该是port没有配置好的问题。

目前已经基本可以肯定打包没有问题。可能的问题是server 或者 port 这些东西没有配置好。明天要做的事情把之前测试用的instance，IAM， SG全部都删掉。看一下AWS关于子网和权限控制的文档，然后重新设计几组实验。

加油，不能拉低母校的就业率！